# Https

## 什么是 HTTPS

HTTPS（全称：Hyper Text Transfer Protocol over Secure Socket Layer），是以安全为目标的HTTP通道，简单讲是HTTP的安全版。即HTTP下加入SSL层，HTTPS的安全基础是SSL，因此加密的详细内容就需要SSL。 现在它被广泛用于万维网上安全敏感的通讯，例如交易支付方面。

## HTTP 与 HTTPS 的区别

- HTTP 是明文传输，HTTPS 通过 SSL\TLS 进行了加密
- HTTP 的端口号是 80，HTTPS 是 443
- HTTPS 需要到 CA 申请证书，一般免费证书很少，需要交费
- HTTPS 的连接很简单，是无状态的；HTTPS 协议是由 SSL+HTTP 协议构建的可进行加密传输、身份认证的网络协议，比 HTTP 协议安全。

## 为什么要使用 HTTPS

其实使用 HTTPS 最主要的用处是以下两点：

- 建立一个信息安全通道，来保证数据传输的安全
- 确认网站的真实性，防止钓鱼网站

## 总是有一种被偷看的感觉

由于张大胖和 Bill 都是使用 HTTP 进行通信，HTTP 是明文的，所以他们的聊天都是可被窥视的。于是，二人准备想要改变现状，所以 HTTPS 首先要解决的问题就是要保证传输的内容只有这两个人能看懂

## plan1：使用对称密钥



![使用对称密钥](https://user-gold-cdn.xitu.io/2017/10/16/4abf02eb238521f76b28b7a7358e975a?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)使用对称密钥



两人商量了一下，可以使用对称密钥进行加密。（对称密钥也就是加密和解密使用的是同一个密钥）

但是问题又来了~既然网络是不安全的，那么最开始的时候怎么将这个对称密钥发送出去呢？如果对称密钥在发送的时候就已经被拦截，那么发送的信息还是会被篡改和窥视啊~~

所以这种对称密钥的弊端就是，可能被中间人拦截，这样中间人就可以获取到了密钥，就可以对传输的信息就行窥视和篡改。

## plan2：使用非对称密钥



![使用非对称密钥](https://user-gold-cdn.xitu.io/2017/10/16/fcd2ed36b921811db8120a572d1bb13e?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)使用非对称密钥



RSA（非对称加密算法）：双方必须协商一对密钥，一个私钥一个公钥。用私钥加密的数据，只有对应的公钥才能解密，用公钥加密的数据， 只有对应的私钥才能解密。



![非对称加密算法](https://user-gold-cdn.xitu.io/2017/10/16/49fb4e92f5a1e38c272d63e1c58f6997?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)非对称加密算法



这样的话 Bill 将自己的公钥给张大胖，张大胖发送的信息使用 Bill 的公钥加密，这样，只有 Bill 使用自己的私钥才能获取

但是这样有个弊端：

- RSA 算法很慢= =，要慢很多

所以为了解决这个问题，我们使用**非对称密钥+对称密钥**结合的方式

## plan3：非对称密钥+对称密钥

使用对称密钥的好处是速度比较快，使用非对称密钥的好处是可以使得传输的内容不能被破解，因为就算你拦截到了数据，但是没有 Bill 的私钥，也是不能破解内容的。就比如说你抢了一个保险柜，但是没有保险柜的钥匙也不能打开保险柜。

所以我们要结合两者的优点。使用 RSA 的方法将加密算法的对称密钥发送过去，之后就可以使用使用这个密钥，利用对称密钥来通信了。就比如说我将钥匙放进了保险柜，然后将保险柜寄给对方。

## 中间人攻击

还有一个问题就是在使用非对称密钥的时候，首先需要将 Bill 的公钥给张大胖，那么在这个过程中，安全是没有保障的，中间人可以拦截到 Bill 的公钥，就可以对拦截到的公钥进行篡改。

这也就是相当于我有手机号，虽然是公开的，谁都可以给我打电话，但是刚开始你并不知道我的手机号，我需要将我的手机号发给你，在我发给你我的手机号的时候，被中间人拦截了，然后将我正确的手机号换成了错误的手机号，比如：110，然后，你收到的就是错误的手机号：110，但是你自己还不知道你收到的是错的手机号，这时候，你要是给我打电话，就尴尬了~~

## 确认身份 —— 数字证书

所以以上的步骤都是可行的，只需要最后一点就可以了，要确定 Bill 给张大胖的公钥确实是 Bill。 的公钥，而不是别人的。（刚刚电话号码的那个例子，也就是说，需要确定我给你发的电话号码是我的，没有被修改的）

那怎么确认 Bill 给张大胖的公钥确实是 Bill 的呢？

这个时候就需要公证处的存在了。也就是说我需要先将我的电话号码到公证处去公证一下，然后我将电话号码传给你之后，你在将你收到的电话号码和公证处的比对下，就知道是不是我的了。

对应到计算机世界，那就是数字签名

![数字签名](https://user-gold-cdn.xitu.io/2017/10/16/6efb9ac7ac6baa22cd88fd35074f46b7?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)数字签名



数字签名也就是相当于公证处在公证书上盖章。



![数字证书](https://user-gold-cdn.xitu.io/2017/10/16/808f41fbb63ec6f3397288368160c7a6?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)数字证书



数字签名和原始信息合在一起称为数字证书，Bill 只需将数字证书发送给张大胖就可以了。

在拿到数字证书之后，就用同样的Hash 算法， 再次生成消息摘要，然后用CA的公钥对数字签名解密， 得到CA创建的消息摘要， 两者一比，就知道有没有人篡改了！



![对比消息摘要是否相同](https://user-gold-cdn.xitu.io/2017/10/16/be5e7b8e6b17fed4edf31dbf4ee65117?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)对比消息摘要是否相同。

## HTTPS 握手过程

1. 服务端将自己的公钥登录至数字证书认证机构，数字证书认证机构用自己的私钥对服务端公钥署数字签名；
2. 客户端发出 HTTPS 请求，请求服务端建立 SSL / TLS 连接；
3. 服务端接收到 HTTPS 请求，将申请到的数字证书和服务端公钥一同返回给客户端；
4. 客户端在接收到服务端公钥后，数字证书认证机构利用提前植入到浏览器的认证公钥，向数字证书认证机构认证公钥证书上的数字签名，确认服务器公钥的真实性；
5. 认证通过之后，客户端随机生成通信使用的密钥，然后使用服务端公钥对密钥进行加密，返回给服务端；
6. 服务端收到加密内容后，通过服务端私钥进行非对称解密，得到客户端密钥，至此双方都获得了对称加密的密钥；
7. 之后，双方使用密钥进行对称加密通信。

https://segmentfault.com/a/1190000022012971

https://juejin.cn/post/6844903764399243278#heading-8